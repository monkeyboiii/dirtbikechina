# Database Network Policies
#
# Allow only specific applications to connect to databases
# Block all other access

---
# PostgreSQL - Allow only from Discourse and Logto
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-allow-from-apps
  namespace: infra
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  ingress:
  # Allow from Discourse (prod)
  - from:
    - namespaceSelector:
        matchLabels:
          environment: production
      podSelector:
        matchLabels:
          app: discourse
    ports:
    - protocol: TCP
      port: 5432

  # Allow from Logto (prod)
  - from:
    - namespaceSelector:
        matchLabels:
          environment: production
      podSelector:
        matchLabels:
          app: logto
    ports:
    - protocol: TCP
      port: 5432

  # Allow from Discourse (stage)
  - from:
    - namespaceSelector:
        matchLabels:
          environment: staging
      podSelector:
        matchLabels:
          app: discourse
    ports:
    - protocol: TCP
      port: 5432

  # Allow from Logto (stage)
  - from:
    - namespaceSelector:
        matchLabels:
          environment: staging
      podSelector:
        matchLabels:
          app: logto
    ports:
    - protocol: TCP
      port: 5432

  # Allow from backup jobs
  - from:
    - namespaceSelector:
        matchLabels:
          environment: infrastructure
      podSelector:
        matchLabels:
          app: postgres-backup
    ports:
    - protocol: TCP
      port: 5432

  # Allow inter-pod communication (for replication if using Patroni/CloudNativePG)
  - from:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 8008  # Patroni REST API (if used)

---
# PostgreSQL Egress - Allow connections for replication, backups
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-egress
  namespace: infra
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Egress
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

  # Allow inter-pod communication (replication)
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
    - protocol: TCP
      port: 8008

  # Allow S3 backups (if using pg_dump to S3)
  # Note: This allows all external HTTPS - tighten if possible
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443

---
# MySQL - Allow only from WordPress and PHPMyAdmin
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mysql-allow-from-apps
  namespace: infra
spec:
  podSelector:
    matchLabels:
      app: mysql
  policyTypes:
  - Ingress
  ingress:
  # Allow from WordPress (prod)
  - from:
    - namespaceSelector:
        matchLabels:
          environment: production
      podSelector:
        matchLabels:
          app: wordpress
    ports:
    - protocol: TCP
      port: 3306

  # Allow from PHPMyAdmin (prod)
  - from:
    - namespaceSelector:
        matchLabels:
          environment: production
      podSelector:
        matchLabels:
          app: phpmyadmin
    ports:
    - protocol: TCP
      port: 3306

  # Allow from WordPress (stage)
  - from:
    - namespaceSelector:
        matchLabels:
          environment: staging
      podSelector:
        matchLabels:
          app: wordpress
    ports:
    - protocol: TCP
      port: 3306

  # Allow from backup jobs
  - from:
    - namespaceSelector:
        matchLabels:
          environment: infrastructure
      podSelector:
        matchLabels:
          app: mysql-backup
    ports:
    - protocol: TCP
      port: 3306

  # Allow inter-pod (for replication if using MySQL InnoDB Cluster)
  - from:
    - podSelector:
        matchLabels:
          app: mysql
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 33060  # MySQL X Protocol
    - protocol: TCP
      port: 33061  # Group Replication

---
# MySQL Egress
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mysql-egress
  namespace: infra
spec:
  podSelector:
    matchLabels:
      app: mysql
  policyTypes:
  - Egress
  egress:
  # DNS
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

  # Inter-pod replication
  - to:
    - podSelector:
        matchLabels:
          app: mysql
    ports:
    - protocol: TCP
      port: 3306
    - protocol: TCP
      port: 33060
    - protocol: TCP
      port: 33061

  # External HTTPS (for backups)
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443
